{"rendered": {"description": {"raw": "Addresses Issue #128\r\n\r\nCurrently observation files are specified from the main Segway process to segway-task.\r\n\r\nThey were being submitted based on the main Segway process\u2019s temporary directory had filenames that started with \u201c/tmp/\u2026\u201d. When attempting to concatenate to path objects with the specified \u201c/tmp/\u2026\u201d, since there was the root \u201c/\u201d it would ignore the temporary directory prefix specifed by segway-task. This was only true of the observation files themselves and not the observation list files specifying the files. Some files were being cleaned up \\(based on segway-task\u2019s temporary current working directory\\) while others were not.\r\n\r\nThe following changes were made to address the issues around temporary observation files:\r\n\r\n1. Observation files, including their names, are solely specified in the segway-task process.\r\n2. All observation files are now all created using mkstemp which includes \u2018O\\_EXCL\u2019 access \\(available on NFS\\) and a secure naming scheme as not to interfere with other processes in case multiple processes are using the same genomic window. No special environment TMPDIR should be necessary \\(from segway-wrapper\\) but is probably still worth keeping.\r\n3. File exceptions are allowed to be raised during file creation or closure \\(e.g. quota issues on NFS\\)\r\n4. All observation files created in this manner are removed after the task is completed or it runs into an exception.\r\n5. All this observation file handling was refactored out and shared across the tasks so all tasks should have the same functionality.\r\n\r\nThe user's `TMPDIR` environment variable will still be the root for where observation files are created since it is set specifically by `segway-wrapper.sh` which spawns segway-task.\r\n\r\nIn `segway-wrapper.sh` as well there is some consideration for removing dead code but may be kept to be extra cautious, but the for loop inside the exit handler, `on_exit`, does nothing:\r\n\r\n        # delete any arguments that begin with $submit_tmpdir\r\n        for arg in \"$@\"; do\r\n            if [[ \"$arg\" == \"$submit_tmpdir\"* ]]; then\r\n                rm -rf \"$TMPDIR\" 2>/dev/null || true\r\n            fi\r\n        done\r\n\r\nThe `$submit_tmpdir` is the parent process Segway's tmpdir. No arguments are supplied \\(in `$@`\\) since the command being run is the script created in the cmdline folder which takes no arguments.\r\n\r\nAfter finishing review, the tests will need to be updated for the cmdline/details/log differences since observation arguments have either been removed or have a different naming scheme \\(no longer based on window ID\\).\r\n\r\n\u200c", "markup": "markdown", "html": "<p>Addresses Issue <a href=\"#!/hoffmanlab/segway/issues/128/stale-file-handle-error\" rel=\"nofollow\" title=\"Stale file handle error\" class=\"ap-connect-link\">#128</a></p>\n<p>Currently observation files are specified from the main Segway process to segway-task.</p>\n<p>They were being submitted based on the main Segway process\u2019s temporary directory had filenames that started with \u201c/tmp/\u2026\u201d. When attempting to concatenate to path objects with the specified \u201c/tmp/\u2026\u201d, since there was the root \u201c/\u201d it would ignore the temporary directory prefix specifed by segway-task. This was only true of the observation files themselves and not the observation list files specifying the files. Some files were being cleaned up (based on segway-task\u2019s temporary current working directory) while others were not.</p>\n<p>The following changes were made to address the issues around temporary observation files:</p>\n<ol>\n<li>Observation files, including their names, are solely specified in the segway-task process.</li>\n<li>All observation files are now all created using mkstemp which includes \u2018O_EXCL\u2019 access (available on NFS) and a secure naming scheme as not to interfere with other processes in case multiple processes are using the same genomic window. No special environment TMPDIR should be necessary (from segway-wrapper) but is probably still worth keeping.</li>\n<li>File exceptions are allowed to be raised during file creation or closure (e.g. quota issues on NFS)</li>\n<li>All observation files created in this manner are removed after the task is completed or it runs into an exception.</li>\n<li>All this observation file handling was refactored out and shared across the tasks so all tasks should have the same functionality.</li>\n</ol>\n<p>The user's <code>TMPDIR</code> environment variable will still be the root for where observation files are created since it is set specifically by <code>segway-wrapper.sh</code> which spawns segway-task.</p>\n<p>In <code>segway-wrapper.sh</code> as well there is some consideration for removing dead code but may be kept to be extra cautious, but the for loop inside the exit handler, <code>on_exit</code>, does nothing:</p>\n<div class=\"codehilite\"><pre><span></span>    <span class=\"cp\"># delete any arguments that begin with $submit_tmpdir</span>\n    <span class=\"k\">for</span> <span class=\"n\">arg</span> <span class=\"k\">in</span> <span class=\"s\">&quot;$@&quot;</span><span class=\"p\">;</span> <span class=\"k\">do</span>\n        <span class=\"k\">if</span> <span class=\"p\">[[</span> <span class=\"s\">&quot;$arg&quot;</span> <span class=\"o\">==</span> <span class=\"s\">&quot;$submit_tmpdir&quot;</span><span class=\"o\">*</span> <span class=\"p\">]];</span> <span class=\"n\">then</span>\n            <span class=\"n\">rm</span> <span class=\"o\">-</span><span class=\"n\">rf</span> <span class=\"s\">&quot;$TMPDIR&quot;</span> <span class=\"mi\">2</span><span class=\"o\">&gt;/</span><span class=\"n\">dev</span><span class=\"o\">/</span><span class=\"n\">null</span> <span class=\"o\">||</span> <span class=\"nb\">true</span>\n        <span class=\"n\">fi</span>\n    <span class=\"n\">done</span>\n</pre></div>\n\n\n<p>The <code>$submit_tmpdir</code> is the parent process Segway's tmpdir. No arguments are supplied (in <code>$@</code>) since the command being run is the script created in the cmdline folder which takes no arguments.</p>\n<p>After finishing review, the tests will need to be updated for the cmdline/details/log differences since observation arguments have either been removed or have a different naming scheme (no longer based on window ID).</p>\n<p>\u200c</p>", "type": "rendered"}, "title": {"raw": "Fix observation files being temporarly and securely created in segway task", "markup": "markdown", "html": "<p>Fix observation files being temporarly and securely created in segway task</p>", "type": "rendered"}}, "type": "pullrequest", "description": "Addresses Issue #128\r\n\r\nCurrently observation files are specified from the main Segway process to segway-task.\r\n\r\nThey were being submitted based on the main Segway process\u2019s temporary directory had filenames that started with \u201c/tmp/\u2026\u201d. When attempting to concatenate to path objects with the specified \u201c/tmp/\u2026\u201d, since there was the root \u201c/\u201d it would ignore the temporary directory prefix specifed by segway-task. This was only true of the observation files themselves and not the observation list files specifying the files. Some files were being cleaned up \\(based on segway-task\u2019s temporary current working directory\\) while others were not.\r\n\r\nThe following changes were made to address the issues around temporary observation files:\r\n\r\n1. Observation files, including their names, are solely specified in the segway-task process.\r\n2. All observation files are now all created using mkstemp which includes \u2018O\\_EXCL\u2019 access \\(available on NFS\\) and a secure naming scheme as not to interfere with other processes in case multiple processes are using the same genomic window. No special environment TMPDIR should be necessary \\(from segway-wrapper\\) but is probably still worth keeping.\r\n3. File exceptions are allowed to be raised during file creation or closure \\(e.g. quota issues on NFS\\)\r\n4. All observation files created in this manner are removed after the task is completed or it runs into an exception.\r\n5. All this observation file handling was refactored out and shared across the tasks so all tasks should have the same functionality.\r\n\r\nThe user's `TMPDIR` environment variable will still be the root for where observation files are created since it is set specifically by `segway-wrapper.sh` which spawns segway-task.\r\n\r\nIn `segway-wrapper.sh` as well there is some consideration for removing dead code but may be kept to be extra cautious, but the for loop inside the exit handler, `on_exit`, does nothing:\r\n\r\n        # delete any arguments that begin with $submit_tmpdir\r\n        for arg in \"$@\"; do\r\n            if [[ \"$arg\" == \"$submit_tmpdir\"* ]]; then\r\n                rm -rf \"$TMPDIR\" 2>/dev/null || true\r\n            fi\r\n        done\r\n\r\nThe `$submit_tmpdir` is the parent process Segway's tmpdir. No arguments are supplied \\(in `$@`\\) since the command being run is the script created in the cmdline folder which takes no arguments.\r\n\r\nAfter finishing review, the tests will need to be updated for the cmdline/details/log differences since observation arguments have either been removed or have a different naming scheme \\(no longer based on window ID\\).\r\n\r\n\u200c", "links": {"decline": {"href": "https://api.bitbucket.org/2.0/repositories/hoffmanlab/segway/pullrequests/90/decline"}, "diffstat": {"href": "https://api.bitbucket.org/2.0/repositories/hoffmanlab/segway/diffstat/hoffmanlab/segway:50f116fc1fdd%0D40e5016c3fbe?from_pullrequest_id=90"}, "commits": {"href": "data/repositories/hoffmanlab/segway/pullrequests/90/commits.json"}, "self": {"href": "data/repositories/hoffmanlab/segway/pullrequests/90.json"}, "comments": {"href": "data/repositories/hoffmanlab/segway/pullrequests/90/comments_page=1.json"}, "merge": {"href": "https://api.bitbucket.org/2.0/repositories/hoffmanlab/segway/pullrequests/90/merge"}, "html": {"href": "#!/hoffmanlab/segway/pull-requests/90"}, "activity": {"href": "data/repositories/hoffmanlab/segway/pullrequests/90/activity.json"}, "diff": {"href": "https://api.bitbucket.org/2.0/repositories/hoffmanlab/segway/diff/hoffmanlab/segway:50f116fc1fdd%0D40e5016c3fbe?from_pullrequest_id=90"}, "approve": {"href": "https://api.bitbucket.org/2.0/repositories/hoffmanlab/segway/pullrequests/90/approve"}, "statuses": {"href": "data/repositories/hoffmanlab/segway/pullrequests/90/statuses_page=1.json"}}, "title": "Fix observation files being temporarly and securely created in segway task", "close_source_branch": true, "reviewers": [{"display_name": "Michael Hoffman", "uuid": "{ffa8e039-5d4d-4f69-a4ba-ac25cbaf700b}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bffa8e039-5d4d-4f69-a4ba-ac25cbaf700b%7D"}, "html": {"href": "https://bitbucket.org/%7Bffa8e039-5d4d-4f69-a4ba-ac25cbaf700b%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/6a95e857a02504cbad5fe965c9d9e4bbd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsMH-1.png"}}, "nickname": "hoffman", "type": "user", "account_id": "557058:a9657985-692c-405c-995b-4e41cda7ba2b"}], "id": 90, "destination": {"commit": {"hash": "40e5016c3fbe", "type": "commit", "links": {"self": {"href": "data/repositories/hoffmanlab/segway/commit/40e5016c3fbe.json"}, "html": {"href": "#!/hoffmanlab/segway/commits/40e5016c3fbe"}}}, "repository": {"links": {"self": {"href": "data/repositories/hoffmanlab/segway.json"}, "html": {"href": "#!/hoffmanlab/segway"}, "avatar": {"href": "data/bytebucket.org/ravatar/{68bf38bf-f0c1-4c9c-909e-0ee4b2c26257}ts=python"}}, "type": "repository", "name": "segway", "full_name": "hoffmanlab/segway", "uuid": "{68bf38bf-f0c1-4c9c-909e-0ee4b2c26257}"}, "branch": {"name": "default"}}, "created_on": "2018-07-12T19:02:00.099406+00:00", "summary": {"raw": "Addresses Issue #128\r\n\r\nCurrently observation files are specified from the main Segway process to segway-task.\r\n\r\nThey were being submitted based on the main Segway process\u2019s temporary directory had filenames that started with \u201c/tmp/\u2026\u201d. When attempting to concatenate to path objects with the specified \u201c/tmp/\u2026\u201d, since there was the root \u201c/\u201d it would ignore the temporary directory prefix specifed by segway-task. This was only true of the observation files themselves and not the observation list files specifying the files. Some files were being cleaned up \\(based on segway-task\u2019s temporary current working directory\\) while others were not.\r\n\r\nThe following changes were made to address the issues around temporary observation files:\r\n\r\n1. Observation files, including their names, are solely specified in the segway-task process.\r\n2. All observation files are now all created using mkstemp which includes \u2018O\\_EXCL\u2019 access \\(available on NFS\\) and a secure naming scheme as not to interfere with other processes in case multiple processes are using the same genomic window. No special environment TMPDIR should be necessary \\(from segway-wrapper\\) but is probably still worth keeping.\r\n3. File exceptions are allowed to be raised during file creation or closure \\(e.g. quota issues on NFS\\)\r\n4. All observation files created in this manner are removed after the task is completed or it runs into an exception.\r\n5. All this observation file handling was refactored out and shared across the tasks so all tasks should have the same functionality.\r\n\r\nThe user's `TMPDIR` environment variable will still be the root for where observation files are created since it is set specifically by `segway-wrapper.sh` which spawns segway-task.\r\n\r\nIn `segway-wrapper.sh` as well there is some consideration for removing dead code but may be kept to be extra cautious, but the for loop inside the exit handler, `on_exit`, does nothing:\r\n\r\n        # delete any arguments that begin with $submit_tmpdir\r\n        for arg in \"$@\"; do\r\n            if [[ \"$arg\" == \"$submit_tmpdir\"* ]]; then\r\n                rm -rf \"$TMPDIR\" 2>/dev/null || true\r\n            fi\r\n        done\r\n\r\nThe `$submit_tmpdir` is the parent process Segway's tmpdir. No arguments are supplied \\(in `$@`\\) since the command being run is the script created in the cmdline folder which takes no arguments.\r\n\r\nAfter finishing review, the tests will need to be updated for the cmdline/details/log differences since observation arguments have either been removed or have a different naming scheme \\(no longer based on window ID\\).\r\n\r\n\u200c", "markup": "markdown", "html": "<p>Addresses Issue <a href=\"#!/hoffmanlab/segway/issues/128/stale-file-handle-error\" rel=\"nofollow\" title=\"Stale file handle error\" class=\"ap-connect-link\">#128</a></p>\n<p>Currently observation files are specified from the main Segway process to segway-task.</p>\n<p>They were being submitted based on the main Segway process\u2019s temporary directory had filenames that started with \u201c/tmp/\u2026\u201d. When attempting to concatenate to path objects with the specified \u201c/tmp/\u2026\u201d, since there was the root \u201c/\u201d it would ignore the temporary directory prefix specifed by segway-task. This was only true of the observation files themselves and not the observation list files specifying the files. Some files were being cleaned up (based on segway-task\u2019s temporary current working directory) while others were not.</p>\n<p>The following changes were made to address the issues around temporary observation files:</p>\n<ol>\n<li>Observation files, including their names, are solely specified in the segway-task process.</li>\n<li>All observation files are now all created using mkstemp which includes \u2018O_EXCL\u2019 access (available on NFS) and a secure naming scheme as not to interfere with other processes in case multiple processes are using the same genomic window. No special environment TMPDIR should be necessary (from segway-wrapper) but is probably still worth keeping.</li>\n<li>File exceptions are allowed to be raised during file creation or closure (e.g. quota issues on NFS)</li>\n<li>All observation files created in this manner are removed after the task is completed or it runs into an exception.</li>\n<li>All this observation file handling was refactored out and shared across the tasks so all tasks should have the same functionality.</li>\n</ol>\n<p>The user's <code>TMPDIR</code> environment variable will still be the root for where observation files are created since it is set specifically by <code>segway-wrapper.sh</code> which spawns segway-task.</p>\n<p>In <code>segway-wrapper.sh</code> as well there is some consideration for removing dead code but may be kept to be extra cautious, but the for loop inside the exit handler, <code>on_exit</code>, does nothing:</p>\n<div class=\"codehilite\"><pre><span></span>    <span class=\"cp\"># delete any arguments that begin with $submit_tmpdir</span>\n    <span class=\"k\">for</span> <span class=\"n\">arg</span> <span class=\"k\">in</span> <span class=\"s\">&quot;$@&quot;</span><span class=\"p\">;</span> <span class=\"k\">do</span>\n        <span class=\"k\">if</span> <span class=\"p\">[[</span> <span class=\"s\">&quot;$arg&quot;</span> <span class=\"o\">==</span> <span class=\"s\">&quot;$submit_tmpdir&quot;</span><span class=\"o\">*</span> <span class=\"p\">]];</span> <span class=\"n\">then</span>\n            <span class=\"n\">rm</span> <span class=\"o\">-</span><span class=\"n\">rf</span> <span class=\"s\">&quot;$TMPDIR&quot;</span> <span class=\"mi\">2</span><span class=\"o\">&gt;/</span><span class=\"n\">dev</span><span class=\"o\">/</span><span class=\"n\">null</span> <span class=\"o\">||</span> <span class=\"nb\">true</span>\n        <span class=\"n\">fi</span>\n    <span class=\"n\">done</span>\n</pre></div>\n\n\n<p>The <code>$submit_tmpdir</code> is the parent process Segway's tmpdir. No arguments are supplied (in <code>$@</code>) since the command being run is the script created in the cmdline folder which takes no arguments.</p>\n<p>After finishing review, the tests will need to be updated for the cmdline/details/log differences since observation arguments have either been removed or have a different naming scheme (no longer based on window ID).</p>\n<p>\u200c</p>", "type": "rendered"}, "source": {"commit": {"hash": "1e0a0949075d", "type": "commit", "links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/ericr86/segway/commit/1e0a0949075d"}, "html": {"href": "https://bitbucket.org/ericr86/segway/commits/1e0a0949075d"}}}, "repository": {"links": {"self": {"href": "https://api.bitbucket.org/2.0/repositories/ericr86/segway"}, "html": {"href": "https://bitbucket.org/ericr86/segway"}, "avatar": {"href": "data/bytebucket.org/ravatar/{e4afec35-c393-4c1b-9d35-155fcd95ef33}ts=python"}}, "type": "repository", "name": "segway", "full_name": "ericr86/segway", "uuid": "{e4afec35-c393-4c1b-9d35-155fcd95ef33}"}, "branch": {"name": "temporary-observation-files"}}, "comment_count": 43, "state": "MERGED", "task_count": 0, "participants": [{"role": "PARTICIPANT", "participated_on": "2018-08-14T15:07:19.868644+00:00", "type": "participant", "approved": false, "user": {"display_name": "Eric Roberts", "uuid": "{cd8c1fe0-28ca-45fb-8ef9-48090b42bb80}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bcd8c1fe0-28ca-45fb-8ef9-48090b42bb80%7D"}, "html": {"href": "https://bitbucket.org/%7Bcd8c1fe0-28ca-45fb-8ef9-48090b42bb80%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/17548d71dfb29d015b880f48cfc01ca3d=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsER-5.png"}}, "nickname": "ericr86", "type": "user", "account_id": "557058:c80ca578-03a1-4ac6-b3ee-50372a3fceee"}}, {"role": "REVIEWER", "participated_on": "2018-09-02T19:20:00.911366+00:00", "type": "participant", "approved": true, "user": {"display_name": "Michael Hoffman", "uuid": "{ffa8e039-5d4d-4f69-a4ba-ac25cbaf700b}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bffa8e039-5d4d-4f69-a4ba-ac25cbaf700b%7D"}, "html": {"href": "https://bitbucket.org/%7Bffa8e039-5d4d-4f69-a4ba-ac25cbaf700b%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/6a95e857a02504cbad5fe965c9d9e4bbd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsMH-1.png"}}, "nickname": "hoffman", "type": "user", "account_id": "557058:a9657985-692c-405c-995b-4e41cda7ba2b"}}], "reason": "", "updated_on": "2018-10-04T17:24:53.624901+00:00", "author": {"display_name": "Eric Roberts", "uuid": "{cd8c1fe0-28ca-45fb-8ef9-48090b42bb80}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bcd8c1fe0-28ca-45fb-8ef9-48090b42bb80%7D"}, "html": {"href": "https://bitbucket.org/%7Bcd8c1fe0-28ca-45fb-8ef9-48090b42bb80%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/17548d71dfb29d015b880f48cfc01ca3d=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsER-5.png"}}, "nickname": "ericr86", "type": "user", "account_id": "557058:c80ca578-03a1-4ac6-b3ee-50372a3fceee"}, "merge_commit": {"hash": "50f116fc1fdd", "type": "commit", "links": {"self": {"href": "data/repositories/hoffmanlab/segway/commit/50f116fc1fdd.json"}, "html": {"href": "#!/hoffmanlab/segway/commits/50f116fc1fdd"}}}, "closed_by": {"display_name": "Eric Roberts", "uuid": "{cd8c1fe0-28ca-45fb-8ef9-48090b42bb80}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bcd8c1fe0-28ca-45fb-8ef9-48090b42bb80%7D"}, "html": {"href": "https://bitbucket.org/%7Bcd8c1fe0-28ca-45fb-8ef9-48090b42bb80%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/17548d71dfb29d015b880f48cfc01ca3d=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsER-5.png"}}, "nickname": "ericr86", "type": "user", "account_id": "557058:c80ca578-03a1-4ac6-b3ee-50372a3fceee"}}