{"priority": "minor", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/hoffmanlab/segway.json"}, "html": {"href": "#!/hoffmanlab/segway"}, "avatar": {"href": "data/bytebucket.org/ravatar/{68bf38bf-f0c1-4c9c-909e-0ee4b2c26257}ts=python"}}, "type": "repository", "name": "segway", "full_name": "hoffmanlab/segway", "uuid": "{68bf38bf-f0c1-4c9c-909e-0ee4b2c26257}"}, "links": {"attachments": {"href": "data/repositories/hoffmanlab/segway/issues/54/attachments_page=1.json"}, "self": {"href": "data/repositories/hoffmanlab/segway/issues/54.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/hoffmanlab/segway/issues/54/watch"}, "comments": {"href": "data/repositories/hoffmanlab/segway/issues/54/comments_page=1.json"}, "html": {"href": "#!/hoffmanlab/segway/issues/54/tests-assume-undefined-tmpdir-to-run"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/hoffmanlab/segway/issues/54/vote"}}, "reporter": {"display_name": "Eric Roberts", "uuid": "{cd8c1fe0-28ca-45fb-8ef9-48090b42bb80}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bcd8c1fe0-28ca-45fb-8ef9-48090b42bb80%7D"}, "html": {"href": "https://bitbucket.org/%7Bcd8c1fe0-28ca-45fb-8ef9-48090b42bb80%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/17548d71dfb29d015b880f48cfc01ca3d=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsER-5.png"}}, "nickname": "ericr86", "type": "user", "account_id": "557058:c80ca578-03a1-4ac6-b3ee-50372a3fceee"}, "title": "Tests assume undefined $TMPDIR to run correctly", "component": null, "votes": 0, "watches": 1, "content": {"raw": "This error can be reproduced by simply running the following in simpleseg:\r\n```shell\r\n$ TMPDIR=/scratch/tmp ./run.sh\r\n```\r\n\r\nThe issue comes from the `mktemp` command used in both `run.sh` and in `segway-wrapper.sh`.\r\n\r\nThe following line in segway-wrapper.sh causes problems when $TMPDIR is already defined:\r\n```shell\r\nexport TMPDIR=\"$(mktemp -dt segway.XXXXXXXXXX)\"\r\n```\r\n\r\n`mktemp` makes the temporary directory based on the template relative to `$TMPDIR`.\r\n\r\nIn `run.sh` (for simpleseg), `TMPDIR` is set but not exported on the following line:\r\n\r\n```shell\r\nTMPDIR=\"$(mktemp -dp . \"test-$(date +%Y%m%d).XXXXXX\")\"\r\n```\r\n\r\n\r\nHowever if `TMPDIR` is already in the environment or exported before `run.sh` is run, then the `TMPDIR` set in run.sh propagates to `segway-wrapper.sh` resulting an unexpected location for the `segway-wrapper.sh` temporary directory.\r\n\r\n\r\nI would propose that in all `run.sh` that before `TMPDIR` is set, the current value of `TMPDIR` is saved and then restored before segway is called.\r\n\r\n\r\n", "markup": "markdown", "html": "<p>This error can be reproduced by simply running the following in simpleseg:</p>\n<div class=\"codehilite language-shell\"><pre><span></span>$ <span class=\"nv\">TMPDIR</span><span class=\"o\">=</span>/scratch/tmp ./run.sh\n</pre></div>\n\n\n<p>The issue comes from the <code>mktemp</code> command used in both <code>run.sh</code> and in <code>segway-wrapper.sh</code>.</p>\n<p>The following line in segway-wrapper.sh causes problems when $TMPDIR is already defined:</p>\n<div class=\"codehilite language-shell\"><pre><span></span><span class=\"nb\">export</span> <span class=\"nv\">TMPDIR</span><span class=\"o\">=</span><span class=\"s2\">&quot;</span><span class=\"k\">$(</span>mktemp -dt segway.XXXXXXXXXX<span class=\"k\">)</span><span class=\"s2\">&quot;</span>\n</pre></div>\n\n\n<p><code>mktemp</code> makes the temporary directory based on the template relative to <code>$TMPDIR</code>.</p>\n<p>In <code>run.sh</code> (for simpleseg), <code>TMPDIR</code> is set but not exported on the following line:</p>\n<div class=\"codehilite language-shell\"><pre><span></span><span class=\"nv\">TMPDIR</span><span class=\"o\">=</span><span class=\"s2\">&quot;</span><span class=\"k\">$(</span>mktemp -dp . <span class=\"s2\">&quot;test-</span><span class=\"k\">$(</span>date +%Y%m%d<span class=\"k\">)</span><span class=\"s2\">.XXXXXX&quot;</span><span class=\"k\">)</span><span class=\"s2\">&quot;</span>\n</pre></div>\n\n\n<p>However if <code>TMPDIR</code> is already in the environment or exported before <code>run.sh</code> is run, then the <code>TMPDIR</code> set in run.sh propagates to <code>segway-wrapper.sh</code> resulting an unexpected location for the <code>segway-wrapper.sh</code> temporary directory.</p>\n<p>I would propose that in all <code>run.sh</code> that before <code>TMPDIR</code> is set, the current value of <code>TMPDIR</code> is saved and then restored before segway is called.</p>", "type": "rendered"}, "assignee": {"display_name": "Eric Roberts", "uuid": "{cd8c1fe0-28ca-45fb-8ef9-48090b42bb80}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bcd8c1fe0-28ca-45fb-8ef9-48090b42bb80%7D"}, "html": {"href": "https://bitbucket.org/%7Bcd8c1fe0-28ca-45fb-8ef9-48090b42bb80%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/17548d71dfb29d015b880f48cfc01ca3d=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsER-5.png"}}, "nickname": "ericr86", "type": "user", "account_id": "557058:c80ca578-03a1-4ac6-b3ee-50372a3fceee"}, "state": "resolved", "version": null, "edited_on": null, "created_on": "2016-02-05T15:45:33.447058+00:00", "milestone": null, "updated_on": "2016-03-07T15:40:21.705437+00:00", "type": "issue", "id": 54}