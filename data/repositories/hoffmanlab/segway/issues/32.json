{"priority": "minor", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/hoffmanlab/segway.json"}, "html": {"href": "#!/hoffmanlab/segway"}, "avatar": {"href": "data/bytebucket.org/ravatar/{68bf38bf-f0c1-4c9c-909e-0ee4b2c26257}ts=python"}}, "type": "repository", "name": "segway", "full_name": "hoffmanlab/segway", "uuid": "{68bf38bf-f0c1-4c9c-909e-0ee4b2c26257}"}, "links": {"attachments": {"href": "data/repositories/hoffmanlab/segway/issues/32/attachments_page=1.json"}, "self": {"href": "data/repositories/hoffmanlab/segway/issues/32.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/hoffmanlab/segway/issues/32/watch"}, "comments": {"href": "data/repositories/hoffmanlab/segway/issues/32/comments_page=1.json"}, "html": {"href": "#!/hoffmanlab/segway/issues/32/error-traindir-likelihood-likelihood0ll"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/hoffmanlab/segway/issues/32/vote"}}, "reporter": {"display_name": "Sakura Tamaki", "uuid": "{2e49c073-0cbe-4333-96b1-a81988007690}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B2e49c073-0cbe-4333-96b1-a81988007690%7D"}, "html": {"href": "https://bitbucket.org/%7B2e49c073-0cbe-4333-96b1-a81988007690%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:8f562ae3-ccee-4990-9d3f-58dc4e5d4282/860719ec-a458-4597-a2c0-04bb410a3373/128"}}, "nickname": "Tamaki_Sakura", "type": "user", "account_id": "557058:8f562ae3-ccee-4990-9d3f-58dc4e5d4282"}, "title": "Error: `traindir/likelihood/likelihood.0.ll` and `traindir/likelihood/likelihood.0.ll` are the same file", "component": null, "votes": 0, "watches": 3, "content": {"raw": "Update 2:\r\nThe root cause of this issue has been found.\r\n\r\nDestination likelihood file is always ```'traindir/likelihood/likelihood.0.ll'``` which is the default since ```save_observation_params``` performs the following:\r\n```\r\n#!python\r\n        if self.train:\r\n            self.set_log_likelihood_filenames()\r\n```\r\n\r\nWhere the ```set_log_likelihood_filenames``` will give ```likelihood.0.ll``` when called without parameters. And ```save_observations_params``` is always called by ```run``` on the main thread.\r\n\r\nIn the mean time, when running with multiple instances, instance 0 will have this file name as generated by another call to  ```set_log_likelihood_filenames```  in ```run_train_instances```, generate another ```likelihood.0.ll```. If instance 0 is the selected winning process, the segway will try to copy the winning log likelihood file to the main thread's saved log likelihood file, which are the same file.\r\n\r\n--------------------------------------------------------------------\r\n\r\nUpdate:\r\nThe error only seems to occur when instance 0 is the winning instance.\r\n\r\n\r\n--------------------------------------------------------------------\r\n\r\nOriginal Post:\r\n*It seems like as long as number of instance is equal to 2* (not true, look for the discussion below), segway will mess up with the source and the destination of the likelihood file at the end of the training when it was trying to manage the result of the training.\r\n\r\nTo reproduce the error, you can modified the run.sh file in test/simpleseg folder in the segway source code, modified the line 28 that call segway train into:\r\n\r\n\r\n```\r\n#!shell\r\n\r\nSEGWAY_RAND_SEED=1498730685 segway \"$cluster_arg\" \\\r\n    --include-coords=\"../include-coords.bed\" --num-instances=2 \\\r\n    --tracks-from=\"../tracks.txt\" --num-labels=2 --max-train-rounds=3 \\\r\n    train \"../simpleseg.genomedata\" traindir \r\n```\r\n\r\n\r\nFull Error Log:\r\n\r\n```\r\n#!\r\n traindir/observations/chr1.0000.float32 (0, 8000)\r\n____ PROGRAM ENDED SUCCESSFULLY WITH STATUS 0 AT Tuesday June 02 2015, 15:29:25 EDT ____\r\nqueued 1: emt0.0.0.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\r\nqueued 2: emt0.0.bundle.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\r\nqueued 3: emt0.1.0.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\r\nqueued 4: emt0.1.bundle.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\r\nqueued 5: emt0.2.0.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\r\nqueued 6: emt0.2.bundle.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\r\nqueued 7: emt1.0.0.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\r\nqueued 8: emt1.0.bundle.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\r\nqueued 9: emt1.1.0.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\r\nqueued 10: emt1.1.bundle.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\r\nqueued 11: emt1.2.0.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\r\nqueued 12: emt1.2.bundle.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\r\nTraceback (most recent call last):\r\n  File \"/mnt/work1/users/home2/xzeng/.local/bin/segway\", line 9, in <module>\r\n    load_entry_point('segway==1.2.2.dev0', 'console_scripts', 'segway')()\r\n  File \"/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py\", line 2580, in main\r\n    return runner()\r\n  File \"/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py\", line 2392, in __call__\r\n    self.run(*args, **kwargs)\r\n  File \"/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py\", line 2358, in run\r\n    self.run_train()\r\n  File \"/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py\", line 1947, in run_train\r\n    self.finish_train(instance_params, dst_filenames)\r\n  File \"/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py\", line 1929, in finish_train\r\n    self.proc_train_results(instance_params, dst_filenames)\r\n  File \"/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py\", line 2052, in proc_train_results\r\n    self.copy_results(name, src_filename, dst_filename)\r\n  File \"/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py\", line 1488, in copy_results\r\n    copy2(src_filename, dst_filename)\r\n  File \"/mnt/work1/software/python/2.7/lib/python2.7/shutil.py\", line 128, in copy2\r\n    copyfile(src, dst)\r\n  File \"/mnt/work1/software/python/2.7/lib/python2.7/shutil.py\", line 69, in copyfile\r\n    raise Error(\"`%s` and `%s` are the same file\" % (src, dst))\r\nshutil.Error: `traindir/likelihood/likelihood.0.ll` and `traindir/likelihood/likelihood.0.ll` are the same file\r\n```\r\n", "markup": "markdown", "html": "<p>Update 2:\nThe root cause of this issue has been found.</p>\n<p>Destination likelihood file is always <code>'traindir/likelihood/likelihood.0.ll'</code> which is the default since <code>save_observation_params</code> performs the following:</p>\n<div class=\"codehilite language-python\"><pre><span></span>        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">train</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">set_log_likelihood_filenames</span><span class=\"p\">()</span>\n</pre></div>\n\n\n<p>Where the <code>set_log_likelihood_filenames</code> will give <code>likelihood.0.ll</code> when called without parameters. And <code>save_observations_params</code> is always called by <code>run</code> on the main thread.</p>\n<p>In the mean time, when running with multiple instances, instance 0 will have this file name as generated by another call to  <code>set_log_likelihood_filenames</code>  in <code>run_train_instances</code>, generate another <code>likelihood.0.ll</code>. If instance 0 is the selected winning process, the segway will try to copy the winning log likelihood file to the main thread's saved log likelihood file, which are the same file.</p>\n<hr />\n<p>Update:\nThe error only seems to occur when instance 0 is the winning instance.</p>\n<hr />\n<p>Original Post:\n<em>It seems like as long as number of instance is equal to 2</em> (not true, look for the discussion below), segway will mess up with the source and the destination of the likelihood file at the end of the training when it was trying to manage the result of the training.</p>\n<p>To reproduce the error, you can modified the run.sh file in test/simpleseg folder in the segway source code, modified the line 28 that call segway train into:</p>\n<div class=\"codehilite language-shell\"><pre><span></span><span class=\"nv\">SEGWAY_RAND_SEED</span><span class=\"o\">=</span><span class=\"m\">1498730685</span> segway <span class=\"s2\">&quot;</span><span class=\"nv\">$cluster_arg</span><span class=\"s2\">&quot;</span> <span class=\"se\">\\</span>\n    --include-coords<span class=\"o\">=</span><span class=\"s2\">&quot;../include-coords.bed&quot;</span> --num-instances<span class=\"o\">=</span><span class=\"m\">2</span> <span class=\"se\">\\</span>\n    --tracks-from<span class=\"o\">=</span><span class=\"s2\">&quot;../tracks.txt&quot;</span> --num-labels<span class=\"o\">=</span><span class=\"m\">2</span> --max-train-rounds<span class=\"o\">=</span><span class=\"m\">3</span> <span class=\"se\">\\</span>\n    train <span class=\"s2\">&quot;../simpleseg.genomedata&quot;</span> traindir \n</pre></div>\n\n\n<p>Full Error Log:</p>\n<div class=\"codehilite\"><pre><span></span> traindir/observations/chr1.0000.float32 (0, 8000)\n____ PROGRAM ENDED SUCCESSFULLY WITH STATUS 0 AT Tuesday June 02 2015, 15:29:25 EDT ____\nqueued 1: emt0.0.0.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\nqueued 2: emt0.0.bundle.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\nqueued 3: emt0.1.0.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\nqueued 4: emt0.1.bundle.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\nqueued 5: emt0.2.0.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\nqueued 6: emt0.2.bundle.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\nqueued 7: emt1.0.0.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\nqueued 8: emt1.0.bundle.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\nqueued 9: emt1.1.0.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\nqueued 10: emt1.1.bundle.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\nqueued 11: emt1.2.0.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\nqueued 12: emt1.2.bundle.traindir.acaf88c8095d11e58ccb5254004fdc17 ()\nTraceback (most recent call last):\n  File &quot;/mnt/work1/users/home2/xzeng/.local/bin/segway&quot;, line 9, in &lt;module&gt;\n    load_entry_point(&#39;segway==1.2.2.dev0&#39;, &#39;console_scripts&#39;, &#39;segway&#39;)()\n  File &quot;/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py&quot;, line 2580, in main\n    return runner()\n  File &quot;/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py&quot;, line 2392, in __call__\n    self.run(*args, **kwargs)\n  File &quot;/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py&quot;, line 2358, in run\n    self.run_train()\n  File &quot;/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py&quot;, line 1947, in run_train\n    self.finish_train(instance_params, dst_filenames)\n  File &quot;/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py&quot;, line 1929, in finish_train\n    self.proc_train_results(instance_params, dst_filenames)\n  File &quot;/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py&quot;, line 2052, in proc_train_results\n    self.copy_results(name, src_filename, dst_filename)\n  File &quot;/mnt/work1/users/home2/xzeng/.local/lib/python2.7/site-packages/segway-1.2.2.dev0-py2.7.egg/segway/run.py&quot;, line 1488, in copy_results\n    copy2(src_filename, dst_filename)\n  File &quot;/mnt/work1/software/python/2.7/lib/python2.7/shutil.py&quot;, line 128, in copy2\n    copyfile(src, dst)\n  File &quot;/mnt/work1/software/python/2.7/lib/python2.7/shutil.py&quot;, line 69, in copyfile\n    raise Error(&quot;`%s` and `%s` are the same file&quot; % (src, dst))\nshutil.Error: `traindir/likelihood/likelihood.0.ll` and `traindir/likelihood/likelihood.0.ll` are the same file\n</pre></div>", "type": "rendered"}, "assignee": {"display_name": "Sakura Tamaki", "uuid": "{2e49c073-0cbe-4333-96b1-a81988007690}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B2e49c073-0cbe-4333-96b1-a81988007690%7D"}, "html": {"href": "https://bitbucket.org/%7B2e49c073-0cbe-4333-96b1-a81988007690%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:8f562ae3-ccee-4990-9d3f-58dc4e5d4282/860719ec-a458-4597-a2c0-04bb410a3373/128"}}, "nickname": "Tamaki_Sakura", "type": "user", "account_id": "557058:8f562ae3-ccee-4990-9d3f-58dc4e5d4282"}, "state": "resolved", "version": null, "edited_on": null, "created_on": "2015-06-02T19:39:04.057362+00:00", "milestone": null, "updated_on": "2015-06-16T19:45:36.607592+00:00", "type": "issue", "id": 32}